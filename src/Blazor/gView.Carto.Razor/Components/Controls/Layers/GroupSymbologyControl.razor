@using gView.GraphicsEngine
@inherits BaseHandler
@inject ICartoApplicationScopeService AppScope

<MudText Typo="Typo.h6">
    @($"{(GroupLayer is null ? "Map" : GroupLayer.Title)} Symbology")
</MudText>
<MudAlert Severity="Severity.Warning">
    Attention: there is no 'undo' for this methods.
    Please save projekt before apply any method.
</MudAlert>
<GvGrid ColumnCount="2">
    <GvGridItem Span="1">
        <GvCard Title="Labelling">
            <GvCardContent>
                <MudText Typo="Typo.body1">
                    Set smoothing mode for all labels in the map.
                </MudText>
            </GvCardContent>
            <GvCardActions>
                <ProgressButton Variant="Variant.Filled" Icon="@_labellingNoSmoothingIcon"
                                Color="Color.Secondary"
                                OnClick="() => OnSetLabelSmoothing(SymbolSmoothing.None)"
                                Title="No Smoothing" />
                <ProgressButton Variant="Variant.Filled" Icon="@_labellingAntialiasIcon"
                                Color="Color.Primary"
                                OnClick="() => OnSetLabelSmoothing(SymbolSmoothing.AntiAlias)" 
                                Title="Antialias" />
            </GvCardActions>
        </GvCard>
    </GvGridItem>
    <GvGridItem Span="1">
        <GvCard Title="Feature Rendering">
            <GvCardContent>
                <MudText Typo="Typo.body1">
                    Set smoothing mode for all features in the map.
                </MudText>
            </GvCardContent>
            <GvCardActions>
                <ProgressButton Variant="Variant.Filled" Icon="@_renderingNoSmoothingIcon"
                                Color="Color.Secondary"
                                OnClick="() => OnSetFeatureSmoothing(SymbolSmoothing.None)" 
                                Title="No Smoothing" />
                <ProgressButton Variant="Variant.Filled" Icon="@_renderingAntialiasIcon"
                                Color="Color.Primary"
                                OnClick="() => OnSetFeatureSmoothing(SymbolSmoothing.AntiAlias)" 
                                Title="Antialias" />
            </GvCardActions>
        </GvCard>
    </GvGridItem>
</GvGrid>
    
<GvGrid>
    <GvGridItem>
        <GvCard Title="Color">
            <GvCardContent>
                <GvGrid ColumnCount="2">
                    <GvGridItem>
                        <MudText Typo="Typo.body1">
                            Set line/outline color for all features in the map.
                        </MudText>
                        <ColorSelectorButton ArgbColor="@_penColor" Icon="@_penIcon"
                                             ArgbColorChanged="(c) => OnSetPenColorClick(_penColor = c)"
                                             Title="Pen Color" />
                    </GvGridItem>
                    <GvGridItem>
                        <MudText Typo="Typo.body1">
                            Set fill color features in the map.
                        </MudText>
                        <ColorSelectorButton ArgbColor="_fillColor" Icon="@_brushIcon"
                                             ArgbColorChanged="(c) => OnSetBrushColorClick(_fillColor = c)"
                                             Title="Fill Color" />
                    </GvGridItem>
                    <GvGridItem>
                        <MudText Typo="Typo.body1">
                            Set font/text color features in the map.
                        </MudText>
                        <ColorSelectorButton ArgbColor="_fontColor" Icon="@_fontColorIcon"
                                             ArgbColorChanged="(c) => OnSetFontColorClick(_fontColor = c)"
                                             Title="Text Color"/>
                    </GvGridItem>
                </GvGrid>
            </GvCardContent>
        </GvCard>
    </GvGridItem>
</GvGrid>

<GvGrid>
    <GvGridItem>
        <GvCard Title="Size">
            <GvGrid ColumnCount="2">
                <GvGridItem>
                    <MudText Typo="Typo.body1">
                        Set pen with (line-width) for all features in the map.
                    </MudText>
                    <MudNumericField @bind-Value="_penWidthFactor" 
                                     Label="Pen-Width factor"/>
                    <ProgressButton Variant="Variant.Filled" Icon="@_penWidthIcon"
                               Color="Color.Primary"
                                    Onclick="async () => { await OnSetPenWidthFactorClick(_penWidthFactor); _penWidthFactor = 1; }"
                               Title="Apply Width Factor" />
                </GvGridItem>
                <GvGridItem>
                    <MudText Typo="Typo.body1">
                        Set symbol size (point size) for all features in the map.
                    </MudText>
                    <MudNumericField @bind-Value="_symbolSizeFactor" 
                                     Label="Symbol-Size factor"/>
                    <ProgressButton Variant="Variant.Filled" Icon="@_symbolSizeIcon"
                               Color="Color.Primary"
                               Onclick="async () => { await OnSetSymbolSizeFactorClick(_penWidthFactor); _symbolSizeFactor = 1; }"
                               Title="Apply Width Factor" />

                </GvGridItem>
            </GvGrid>
        </GvCard>
    </GvGridItem>
</GvGrid>
        
@code {
    [Parameter] public IMap? Map { get; set; }
    [Parameter] public IGroupLayer? GroupLayer { get; set; }

    private ArgbColor _penColor, _fillColor, _fontColor;
    float _penWidthFactor = 1f, _symbolSizeFactor = 1f;

    private Task OnSetPenColorClick(ArgbColor color) => HandleAsync(() =>
        WithUi(() =>
            ForEachFeatureRendererSymbol<IPenColor>(pen =>
                pen.PenColor = ArgbColor.FromArgb(pen.PenColor.A, color)
            ),
            UIButton.Pen
        )
    );

    private Task OnSetBrushColorClick(ArgbColor color) => HandleAsync(() =>
        WithUi(() =>
            ForEachFeatureRendererSymbol<IBrushColor>(brush =>
                brush.FillColor = ArgbColor.FromArgb(brush.FillColor.A, color)
            ),
            UIButton.Brush
        )
    );

    private Task OnSetFontColorClick(ArgbColor color) => HandleAsync(() =>
        WithUi(() =>
            ForEachLabelRendererSymbol<IFontColor>(font =>
                font.FontColor = ArgbColor.FromArgb(font.FontColor.A, color)
            ),
            UIButton.FontColor
        )
    );

    private Task OnSetPenWidthFactorClick(float widthFactor) => HandleAsync(() =>
        WithUi(() =>
            ForEachFeatureRendererSymbol<IPenWidth>(pen =>
                pen.PenWidth *= widthFactor
            ),
            UIButton.PenWidth
        )
    );

    private Task OnSetSymbolSizeFactorClick(float widthFactor) => HandleAsync(() =>
        WithUi(() =>
            ForEachFeatureRendererSymbol<ISymbolSize>(symbol =>
                symbol.SymbolSize *= widthFactor
        ),
            UIButton.SymbolSize
        )
    );

    private Task OnSetFeatureSmoothing(SymbolSmoothing smoothing) => HandleAsync(() =>
        WithUi(() => 
            ForEachFeatureRendererSymbol<ISymbol>(symbol =>
                symbol.SymbolSmoothingMode = smoothing
            ),
            smoothing == SymbolSmoothing.None ? UIButton.RenderingNoSmoothing : UIButton.RenderingAntialias
            )
        );

    private Task OnSetLabelSmoothing(SymbolSmoothing smoothing) => HandleAsync(() =>
        WithUi(() =>
            ForEachLabelRendererSymbol<ISymbol>(symbol =>
                symbol.SymbolSmoothingMode = smoothing
            ),
            smoothing == SymbolSmoothing.None ? UIButton.LabellingNoSmoothing : UIButton.LabellingAntialias
            )
        );

    #region UI

    private enum UIButton
    {
        All,
        Pen,
        Brush,
        FontColor,
        LabellingNoSmoothing,
        LabellingAntialias,
        RenderingNoSmoothing,
        RenderingAntialias,
        PenWidth,
        SymbolSize
    }

    private const string CheckIcon = MudBlazor.Icons.Material.Rounded.Check;
    private string? _penIcon, _brushIcon, _fontColorIcon;
    private string? _labellingNoSmoothingIcon, _labellingAntialiasIcon;
    private string? _renderingNoSmoothingIcon, _renderingAntialiasIcon;
    private string? _penWidthIcon, _symbolSizeIcon;

    async private Task WithUi(Action action, UIButton uiButton)
    {
        //SetUIButtonIcon(UIButton.All, null);

        SetUIButtonIcon(uiButton, ProgressButton.ProgressIcon);

        await ForceRenderComponent();
        action();
        await AppScope.EventBus.FireRefreshMapAsync();
        await Task.Delay(1000);

        SetUIButtonIcon(uiButton, CheckIcon);
    }

    private void SetUIButtonIcon(UIButton uIButton, string? icon)
    {
        switch(uIButton)
        {
            case UIButton.Pen: _penIcon = icon; break;
            case UIButton.Brush: _brushIcon = icon; break;
            case UIButton.FontColor: _fontColorIcon = icon; break;
            case UIButton.LabellingNoSmoothing: _labellingNoSmoothingIcon = icon; _labellingAntialiasIcon = null; break;
            case UIButton.LabellingAntialias: _labellingAntialiasIcon = icon; _labellingNoSmoothingIcon = null; break;
            case UIButton.RenderingNoSmoothing: _renderingNoSmoothingIcon = icon; _renderingAntialiasIcon = null; break;
            case UIButton.RenderingAntialias: _renderingAntialiasIcon = icon; _renderingNoSmoothingIcon = null; break;
            case UIButton.PenWidth: _penWidthIcon = icon; break;
            case UIButton.SymbolSize: _symbolSizeIcon = icon; break;
            default:
                _penIcon = _brushIcon = _fontColorIcon = icon;
                _labellingNoSmoothingIcon = _labellingAntialiasIcon = icon;
                _renderingNoSmoothingIcon = _renderingAntialiasIcon = icon;
                _penWidthIcon = _symbolSizeIcon = icon;
                break;
        }
    }

    #endregion

    #region Iterators

    private void ForEachLayer<T>(Action<T> action) where T : ILayer
        => Map?.MapElements.GetLayersInGroup<T>(GroupLayer?.ID, recursive: true).ToList().ForEach(action);

    private void ForeachFeatureRenderer(Action<IFeatureRenderer> action)
        => ForEachLayer<IFeatureLayer>((featureLayer) =>
        {
            if (featureLayer?.FeatureRenderer is not null) action(featureLayer.FeatureRenderer);
        });

    private void ForeachLabelRenderer(Action<ILabelRenderer> action)
        => ForEachLayer<IFeatureLayer>((featureLayer) =>
        {
            if (featureLayer?.LabelRenderer is not null) action(featureLayer.LabelRenderer);
        });

    private void ForEachFeatureRendererSymbol<T>(Action<T> action)
        => ForeachFeatureRenderer((featureRenderer) =>
        {
            featureRenderer.Symbols?.ToList().ForEach((symbol) =>
            {
                if (typeof(T).IsAssignableFrom(symbol.GetType())) action((T)symbol);
            });
        });

    private void ForEachLabelRendererSymbol<T>(Action<T> action)
        => ForeachLabelRenderer((labelRenderer) =>
        {
            labelRenderer.Symbols?.ToList().ForEach((symbol) =>
            {
                if (typeof(T).IsAssignableFrom(symbol.GetType())) action((T)symbol);
            });
        });

    #endregion
}